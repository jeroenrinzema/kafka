services:
  kafka:
    image: apache/kafka:3.9.0
    hostname: kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_LOG_DIRS: /var/lib/kafka/data
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Demo application that generates sample logs
  demo-app:
    image: alpine:3.19
    hostname: demo-app
    container_name: demo-app
    volumes:
      - app-logs:/var/log/app
      - ./scripts:/scripts
    command: >
      /bin/sh -c '
        mkdir -p /var/log/app &&
        while true; do
          LEVEL=$$(shuf -e INFO INFO INFO INFO WARN ERROR DEBUG | head -n 1)
          APP=$$(shuf -e auth-service api-gateway user-service payment-service | head -n 1)
          MSG=$$(shuf -e "Request processed successfully" "Connection established" "Cache miss" "Database query executed" "Session created" "Token validated" "Rate limit checked" "Health check passed" "Configuration loaded" "Metrics collected" | head -n 1)
          TRACE_ID=$$(cat /dev/urandom | tr -dc "a-f0-9" | head -c 16)
          USER_ID=$$((RANDOM % 10000))
          LATENCY=$$((RANDOM % 500))
          echo "{\"timestamp\":\"$$(date -Iseconds)\",\"level\":\"$$LEVEL\",\"app_name\":\"$$APP\",\"message\":\"$$MSG\",\"trace_id\":\"$$TRACE_ID\",\"user_id\":$$USER_ID,\"latency_ms\":$$LATENCY}"
          echo "{\"timestamp\":\"$$(date -Iseconds)\",\"level\":\"$$LEVEL\",\"app_name\":\"$$APP\",\"message\":\"$$MSG\",\"trace_id\":\"$$TRACE_ID\",\"user_id\":$$USER_ID,\"latency_ms\":$$LATENCY}" >> /var/log/app/application.log
          sleep 1
        done
      '

  # Vector collector - reads logs and sends to Kafka
  vector-collector:
    image: timberio/vector:0.41.1-alpine
    hostname: vector-collector
    container_name: vector-collector
    ports:
      - "9598:9598"  # Vector metrics endpoint
    volumes:
      - ./config/vector-collector.toml:/etc/vector/vector.toml:ro
      - app-logs:/var/log/app:ro
      - vector-data:/var/lib/vector
    depends_on:
      kafka:
        condition: service_healthy
      demo-app:
        condition: service_started
    command: ["--config", "/etc/vector/vector.toml"]

  # Vector consumer - reads from Kafka and outputs to console
  vector-consumer:
    image: timberio/vector:0.41.1-alpine
    hostname: vector-consumer
    container_name: vector-consumer
    volumes:
      - ./config/vector-consumer.toml:/etc/vector/vector.toml:ro
    depends_on:
      kafka:
        condition: service_healthy
      vector-collector:
        condition: service_started
    command: ["--config", "/etc/vector/vector.toml"]

  # Kafka UI for visualization
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092

volumes:
  kafka-data:
  app-logs:
  vector-data:
